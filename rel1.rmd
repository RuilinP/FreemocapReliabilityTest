---
title: "reliability1"
author: "Ruilin Peng"
date: "2025-12-10"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Data Loading from freemocap regarding left foot
```{r}
library(read.gt3x)
library(data.table)

df <- fread("data/recording_15_41_06_gmt+8_by_trajectory.csv")

cols_keep <- c(
  "timestamp",
  "com_left_foot_x", "com_left_foot_y", "com_left_foot_z"
)

df <- df[, ..cols_keep]
```

# Load data from actigraph
```{r}
gt3x_path1 <- "data/MOS2E48230454 (2025-12-04).gt3x"
gt3x_path2 <- "data/MOS2E48230491 (2025-12-04).gt3x"
gt3x_path3 <- "data/MOS2E48230815 (2025-12-04).gt3x"

g1 <- read.gt3x(gt3x_path1, asDataFrame = TRUE, imputeZeroes = TRUE)
g2 <- read.gt3x(gt3x_path2, asDataFrame = TRUE, imputeZeroes = TRUE)
g3 <- read.gt3x(gt3x_path3, asDataFrame = TRUE, imputeZeroes = TRUE)
dt1 <- as.data.table(g1)
dt2 <- as.data.table(g2)
dt3 <- as.data.table(g3)
```

```{r}

# 1) Define the time window
start_time <- as.POSIXct("2025-12-04 15:41:06", tz = "UTC")
end_time   <- start_time + 5*60 + 8   # 10 minutes later

# 2) Make sure 'time' is POSIXct
dt_list <- list(dt1, dt2, dt3)
for (i in seq_along(dt_list)) {
  dt_list[[i]][, time := as.POSIXct(time, tz = "UTC")]
}

dt1 <- dt_list[[1]]
dt2 <- dt_list[[2]]
dt3 <- dt_list[[3]]

# 3A) Keep ONLY that 10-minute window:
dt1_5min <- dt1[time >= start_time & time <= end_time]
dt2_5min <- dt2[time >= start_time & time <= end_time]
dt3_5min <- dt3[time >= start_time & time <= end_time]


```
Manually filter the interval
```{r}
# Put them in a list to treat all three the same way
dt5_list <- list(dt1_5min, dt2_5min, dt3_5min)

for (i in seq_along(dt5_list)) {
  dt5_list[[i]][,
    `:=`(
      # Euclidean magnitude (classic vector length)
      a_mag_g = sqrt(X^2 + Y^2 + Z^2),

      # Sum of absolutes (what the tennis paper used)
      mag_sumabs_g = abs(X) + abs(Y) + abs(Z)
    )
  ]
}

dt1_5min <- dt5_list[[1]]
dt2_5min <- dt5_list[[2]]
dt3_5min <- dt5_list[[3]]
```


```{r}
fwrite(dt1_5min, "acc_5min_xyz_g1.csv")
fwrite(dt2_5min, "acc_5min_xyz_g2.csv")
fwrite(dt3_5min, "acc_5min_xyz_g3.csv")
```
output to csv

```{r}
library(ggplot2)
ggplot(dt1_5min, aes(time, a_mag_g)) +
  geom_line(color="red") + 
  ggtitle("Actigraph 1 acceleration magnitude in g")

ggplot(dt2_5min, aes(time, a_mag_g)) +
  geom_line(color="blue") + 
  ggtitle("Actigraph 2 acceleration magnitude in g")

ggplot(dt3_5min, aes(time, a_mag_g)) +
  geom_line(color="green") + 
  ggtitle("Actigraph 3 acceleration magnitude in g")
```



# Plot the 3 timeseries
```{r}
df[, t := (timestamp - timestamp[1]) / 1e9]   # convert ns → seconds
ggplot(df, aes(x = t, y = com_left_foot_x)) +
  geom_line(color = "red") +
  theme_minimal() +
  labs(title = "Left Foot COM: X coordinate", x = "Time (s)", y = "X (units?)")

```

```{r}
ggplot(df, aes(x = t, y = com_left_foot_y)) +
  geom_line(color = "blue") +
  theme_minimal() +
  labs(title = "Left Foot COM: Y coordinate", x = "Time (s)", y = "Y (units?)")

```

```{r}
ggplot(df, aes(x = t, y = com_left_foot_z)) +
  geom_line(color = "green") +
  theme_minimal() +
  labs(title = "Left Foot COM: Z coordinate", x = "Time (s)", y = "Z (units?)")

```

# Outliers removal
From plots above we can observe outliers, which can significantly influence the correlation afterward.
```{r}
remove_outliers_mad <- function(x, k = 6) {
  med  <- median(x, na.rm = TRUE)
  madv <- mad(x, constant = 1, na.rm = TRUE)
  dev  <- abs(x - med)

  x[dev > k*madv] <- NA
  return(x)
}

```
We first assign NA to data points whose deviation is greater than 6 MADs(Median Absolute Deviation) away from the median
```{r}
df[, com_left_foot_x := remove_outliers_mad(com_left_foot_x)]
df[, com_left_foot_y := remove_outliers_mad(com_left_foot_y)]
df[, com_left_foot_z := remove_outliers_mad(com_left_foot_z)]
```

```{r}
library(zoo)

df[, com_left_foot_x := na.approx(com_left_foot_x, na.rm = FALSE)]
df[, com_left_foot_y := na.approx(com_left_foot_y, na.rm = FALSE)]
df[, com_left_foot_z := na.approx(com_left_foot_z, na.rm = FALSE)]

```
Then we incorporate missing values.
```{r}

ggplot(df, aes(t, com_left_foot_x)) +
  geom_line(color="red") + 
  ggtitle("Left Foot COM X (Filtered)")

ggplot(df, aes(t, com_left_foot_y)) +
  geom_line(color="blue") + 
  ggtitle("Left Foot COM Y (Filtered)")

ggplot(df, aes(t, com_left_foot_z)) +
  geom_line(color="green") + 
  ggtitle("Left Foot COM Z (Filtered)")

```
Plotting again.

# Compute acceleration

```{r}
compute_accel_from_pos <- function(df,
                                   x_col, y_col, z_col,
                                   t_col = "t",
                                   units_mm = TRUE,
                                   vel_prefix = "v_",
                                   acc_prefix = "a_",
                                   mag_name   = "a_mag_g") {

  # work on a copy, so original df is unchanged
  dt <- data.table::as.data.table(data.table::copy(df))

  # 1) time step (s)
  dt[, dt_ := c(NA_real_, diff(get(t_col)))]

  # 2) convert mm → m if needed
  if (units_mm) {
    dt[, (c(x_col, y_col, z_col)) :=
          lapply(.SD, function(v) v / 1000),
       .SDcols = c(x_col, y_col, z_col)]
  }

  # 3) velocity components
  vx_name <- paste0(vel_prefix, "x")
  vy_name <- paste0(vel_prefix, "y")
  vz_name <- paste0(vel_prefix, "z")

  dt[, (vx_name) := c(NA_real_, diff(get(x_col))) / dt_]
  dt[, (vy_name) := c(NA_real_, diff(get(y_col))) / dt_]
  dt[, (vz_name) := c(NA_real_, diff(get(z_col))) / dt_]

  # 4) acceleration components
  ax_name <- paste0(acc_prefix, "x")
  ay_name <- paste0(acc_prefix, "y")
  az_name <- paste0(acc_prefix, "z")

  dt[, (ax_name) := c(NA_real_, diff(get(vx_name))) / dt_]
  dt[, (ay_name) := c(NA_real_, diff(get(vy_name))) / dt_]
  dt[, (az_name) := c(NA_real_, diff(get(vz_name))) / dt_]

  # 5) magnitude in m/s^2
  dt[, a_mag_ms2 :=
        sqrt(get(ax_name)^2 + get(ay_name)^2 + get(az_name)^2)]

  # 6) convert to g
  g_const <- 9.80665
  dt[, (mag_name) := a_mag_ms2 / g_const]

  # 7) optional: drop helper column
  dt[, dt_ := NULL]

  return(dt)
}


```

```{r}
df1  <- compute_accel_from_pos(
  df,
  x_col = "com_left_foot_x",
  y_col = "com_left_foot_y",
  z_col = "com_left_foot_z",
  t_col = "t",       
  units_mm = TRUE
)
```

```{r}
head(df1)
```
```{r}
ggplot(df1, aes(t, a_mag_g)) +
  geom_line(color="red") + 
  ggtitle("Left Foot acceleration magnitude in g")
```
Plotting acceleration and we can observe there are more outliers after computing acceleration

# Fix spikes in acceleartion
```{r}
library(zoo)
df$x_smooth <- rollmean(df$com_left_foot_x, k = 7, fill = NA)
df$y_smooth <- rollmean(df$com_left_foot_y, k = 7, fill = NA)
df$z_smooth <- rollmean(df$com_left_foot_z, k = 7, fill = NA)
```
Starting by simple moving average
```{r}
df_smooth  <- compute_accel_from_pos(
  df,
  x_col = "x_smooth",
  y_col = "y_smooth",
  z_col = "z_smooth",
  t_col = "t",       
  units_mm = TRUE
)

```

```{r}
ggplot(df_smooth, aes(t, a_mag_g)) +
  geom_line(color="red") + 
  ggtitle("Left Foot acceleration magnitude in g(smooth)")
```






```{r}
df_smooth = df_smooth[ a_mag_g < 0 | a_mag_g > 15, a_mag_g := NA ]


ggplot(df_smooth, aes(t, a_mag_g)) +
  geom_line(color="red") + 
  ggtitle("Left Foot acceleration magnitude in g(smooth, outlier removed for g greater than 15g)")
```

# Rebuild timestamp for freemocap data

```{r}
setDT(df_smooth)

# anchor time: same as your IMU series
anchor_time <- as.POSIXct("2025-12-04 15:41:06", tz = "UTC")

# helper: build absolute time from dt (sec differences)
make_time_from_dt <- function(dt_vec, t0) {
  # replace NA in first row with 0
  dt_clean <- ifelse(is.na(dt_vec), 0, dt_vec)
  t0 + dt_clean
}

df_smooth[, time := make_time_from_dt(t, anchor_time)]

```

```{r}
ggplot(df_smooth, aes(time, a_mag_g)) +
  geom_line(color="red") + 
  ggtitle("Left Foot acceleration magnitude in g(smooth, outlier removed for g greater than 15g, absolute time)")
```
# 